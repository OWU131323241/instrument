<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>楽器ゲーム本体</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; }
        #score { white-space: pre-wrap; font-size: 24px; background: #222; padding: 20px; margin: 20px; border-radius: 10px; }
        .playing { color: #4ade80; font-weight: bold; }
    </style>
</head>
<body>
    <h1>AI楽器ゲーム</h1>
    <input type="text" id="songName" placeholder="曲名を入力 (例: カエルの合唱)">
    <button onclick="generateScore()">楽譜を生成</button>
    <div id="score">ここに楽譜が表示されます</div>

    <script>
        const socket = io();
        // ピアノに近い音色のシンセサイザー設定
        const piano = new Tone.Sampler({
            urls: {
                A0: "A0.mp3", C1: "C1.mp3", "D#1": "Ds1.mp3", "F#1": "Fs1.mp3", A1: "A1.mp3", C2: "C2.mp3", "D#2": "Ds2.mp3", "F#2": "Fs2.mp3", A2: "A2.mp3", C3: "C3.mp3", "D#3": "Ds3.mp3", "F#3": "Fs3.mp3", A3: "A3.mp3", C4: "C4.mp3", "D#4": "Ds4.mp3", "F#4": "Fs4.mp3", A4: "A4.mp3", C5: "C5.mp3", "D#5": "Ds5.mp3", "F#5": "Fs5.mp3", A5: "A5.mp3", C6: "C6.mp3", "D#6": "Ds6.mp3", "F#6": "Fs6.mp3", A6: "A6.mp3", C7: "C7.mp3", "D#7": "Ds7.mp3", "F#7": "Fs7.mp3", A7: "A7.mp3", C8: "C8.mp3"
            },
            release: 1,
            baseUrl: "https://tonejs.github.io/audio/salamander/"
        }).toDestination();

        let currentNote = null;

        socket.on("sensor", (data) => {
            if (data.active) {
                // 角度を音程に変換 (-90〜90度を C3〜C5くらいに割り当て)
                const notes = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"];
                const index = Math.floor(((data.angle + 90) / 180) * notes.length);
                const note = notes[Math.max(0, Math.min(index, notes.length - 1))];

                if (note !== currentNote) {
                    piano.triggerRelease(); // 前の音を止める
                    piano.triggerAttack(note); // 新しい音を鳴らす
                    currentNote = note;
                }
            } else {
                piano.triggerRelease(); // 指が離れたら音を止める
                currentNote = null;
            }
        });

        async function generateScore() {
            const songName = document.getElementById("songName").value;
            const res = await fetch("/api/generate-score", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ songName })
            });
            const data = await res.json();
            document.getElementById("score").innerText = data.text;
            // 音を出す準備（ブラウザの制限対策）
            await Tone.start();
        }
    </script>
</body>
</html>
