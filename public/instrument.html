<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Tilt Synth - æ¼”å¥ç”»é¢</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { margin:0; background:#0f172a; color:#f1f5f9; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
        h1 { margin-top: 20px; color: #3b82f6; }
        
        /* æ¥½è­œã‚¨ãƒªã‚¢ */
        #score { 
            width: 90%; max-width: 600px; background: #1e293b; padding: 25px; 
            border-radius: 15px; margin: 20px 0; text-align: left; 
            white-space: pre-wrap; font-size: 24px; line-height: 1.8; 
            border-left: 5px solid #3b82f6; min-height: 100px;
        }

        /* ãƒ¢ãƒ‹ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆè§’åº¦ã¨éŸ³åï¼‰ */
        .monitor { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; 
            width: 90%; max-width: 600px; margin-top: 10px; 
        }
        .card { background: #070e1e; padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #334155; }
        .label { font-size: 14px; color: #94a3b8; margin-bottom: 10px; text-transform: uppercase; }
        .val { font-size: 48px; font-weight: bold; color: #60a5fa; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area { margin-bottom: 20px; }
        input { padding: 12px; font-size: 18px; border-radius: 8px; border: none; width: 250px; }
        button { padding: 12px 24px; font-size: 18px; border-radius: 8px; background: #3b82f6; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #2563eb; }

        /* --- ã€è¿½åŠ ã€‘å³ä¸‹ã®QRã‚³ãƒ¼ãƒ‰è¨­å®š --- */
        .qr-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        .qr-container img {
            width: 120px; /* ãŠå¥½ã¿ã®ã‚µã‚¤ã‚ºã«èª¿æ•´ã—ã¦ãã ã•ã„ */
            height: auto;
            border-radius: 10px;
            border: 2px solid #334155;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <h1>ğŸ¸ AI Tilt Piano</h1>

    <div class="input-area">
        <input type="text" id="songInput" placeholder="æ›²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        <button onclick="generateScore()">æ¥½è­œç”Ÿæˆ</button>
    </div>

    <div id="score">ã“ã“ã«æ¥½è­œãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>

    <div class="monitor">
        <div class="card">
            <div class="label">Angle</div>
            <div id="angleDisp" class="val">0Â°</div>
        </div>
        <div class="card">
            <div class="label">Note</div>
            <div id="noteDisp" class="val">--</div>
        </div>
    </div>

    <div class="qr-container">
        <img src="qr.png" alt="QR Code">
    </div>

    <script>
        // ... (ä»¥ä¸‹ã€æ—¢å­˜ã®JavaScriptã‚³ãƒ¼ãƒ‰ã¨åŒã˜) ...
        const socket = io();
        const NOTES_JP = ["ãƒ‰", "ãƒ¬", "ãƒŸ", "ãƒ•ã‚¡", "ã‚½", "ãƒ©", "ã‚·", "ãƒ‰"];
        const NOTES_TONE = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"];

        const piano = new Tone.Sampler({
            urls: {
                C4: "C4.mp3", "D#4": "Ds4.mp3", "F#4": "Fs4.mp3", A4: "A4.mp3",
                C5: "C5.mp3"
            },
            release: 1,
            baseUrl: "https://tonejs.github.io/audio/salamander/"
        }).toDestination();

        let currentNoteIndex = null;

        socket.on("sensor", (data) => {
            const angleEl = document.getElementById("angleDisp");
            const noteEl = document.getElementById("noteDisp");

            const angle = Math.round(data.angle);
            angleEl.textContent = angle + "Â°";

            let index = Math.floor(((data.angle + 45) / 90) * NOTES_TONE.length);
            index = Math.max(0, Math.min(index, NOTES_TONE.length - 1));
            
            noteEl.textContent = NOTES_JP[index];

            if (data.active) {
                if (index !== currentNoteIndex) {
                    const note = NOTES_TONE[index];
                    piano.triggerRelease(); 
                    piano.triggerAttack(note);
                    currentNoteIndex = index;
                }
            } else {
                piano.triggerRelease();
                currentNoteIndex = null;
            }
        });

        async function generateScore() {
            // ã€é‡è¦ã€‘ã“ã“ãŒæŠœã‘ã¦ã„ã¾ã™ï¼å…¥åŠ›æ¬„ã‹ã‚‰æ›²åã‚’å–å¾—ã™ã‚‹
            const songName = document.getElementById("songInput").value;
            
            if (!songName) {
                alert("æ›²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
        
            if (!isAudioStarted) await initAudio();
            
            const scoreEl = document.getElementById("score");
            scoreEl.innerText = "ç”Ÿæˆä¸­...";
        
            try {
                const res = await fetch("/api/generate-score", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ songName }) // ã“ã“ã§ä½¿ã£ã¦ã„ã‚‹ songName ãŒä¸Šã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                });
                
                const data = await res.json();
                
                if (data.error) {
                    scoreEl.innerText = "ã‚¨ãƒ©ãƒ¼: " + data.error;
                } else {
                    scoreEl.innerText = data.text;
                }
                
            } catch (e) {
                console.error(e);
                scoreEl.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            }
        }
    </script>
</body>
</html>
