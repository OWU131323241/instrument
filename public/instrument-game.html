<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Tilt Synth</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>

<style>
  body{
    margin:0;
    background:#0f1720;
    color:#e6eef8;
    font-family:system-ui;
  }
  .wrap{
    display:flex;
    height:100vh;
  }
  .left{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .right{
    width:360px;
    padding:20px;
    background:#07101a;
  }
  .btn{
    width:200px;
    height:200px;
    border-radius:50%;
    background:#dbeafe;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:24px;
    font-weight:bold;
    color:#071433;
    user-select:none;
  }
  .btn.inactive{
    background:#1e293b;
    color:#94a3b8;
  }
  .big{
    font-size:64px;
    font-weight:bold;
    text-align:center;
  }
  .sub{
    text-align:center;
    opacity:.8;
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="left">
    <div id="mobileUI">
      <div id="btn" class="btn inactive">HOLD</div>
      <p>スマホを傾けて音程操作</p>
    </div>
  </div>

  <div class="right" id="pcUI">
    <div>角度</div>
    <div id="angle">--°</div>
    <div class="big" id="note">--</div>
    <div class="sub" id="freq">-- Hz</div>
    <hr>
    <div id="aiComment">AIコメント表示エリア</div>
  </div>
</div>

<script>
/* ===============================
   URL判定（ここが重要）
================================ */
const isSmart = location.pathname.endsWith(".smart");

/* ===============================
   Socket.IO
================================ */
const SERVER_URL = location.origin;
const socket = io(SERVER_URL);

/* ===============================
   音階設定
================================ */
const MAX_ANGLE = 45;
const BASE_MIDI = 60; // C4
const NOTES_JP = ["ド","ド#","レ","レ#","ミ","ファ","ファ#","ソ","ソ#","ラ","ラ#","シ"];

function midiToFreq(m){
  return 440 * Math.pow(2,(m-69)/12);
}
function angleToSemitone(a){
  const r = Math.max(-MAX_ANGLE,Math.min(MAX_ANGLE,a)) / MAX_ANGLE;
  return Math.round(r*12);
}
function noteName(midi){
  const n = NOTES_JP[midi%12];
  const o = Math.floor(midi/12)-1;
  return n + o;
}

/* ===============================
   Audio
================================ */
let ctx, osc, gain, playing=false;
function startSound(freq){
  if(!ctx){
    ctx=new AudioContext();
    gain=ctx.createGain();
    gain.connect(ctx.destination);
  }
  if(playing){
    osc.frequency.setTargetAtTime(freq,ctx.currentTime,0.02);
    return;
  }
  osc=ctx.createOscillator();
  osc.type="sine";
  osc.frequency.value=freq;
  osc.connect(gain);
  gain.gain.value=0.2;
  osc.start();
  playing=true;
}
function stopSound(){
  if(!playing) return;
  osc.stop();
  osc.disconnect();
  playing=false;
}

/* ===============================
   UI制御
================================ */
const btn=document.getElementById("btn");
const angleEl=document.getElementById("angle");
const noteEl=document.getElementById("note");
const freqEl=document.getElementById("freq");
const pcUI=document.getElementById("pcUI");
const mobileUI=document.getElementById("mobileUI");

/* PC / スマホ表示切替 */
if(isSmart){
  pcUI.style.display="none";
}else{
  mobileUI.style.display="none";
}

/* ===============================
   スマホ：傾き送信
================================ */
if(isSmart){
  btn.addEventListener("touchstart",e=>{
    e.preventDefault();
    startSend();
  });
  btn.addEventListener("touchend",e=>{
    e.preventDefault();
    stopSend();
  });
}

let sending=false;
function startSend(){
  btn.classList.remove("inactive");
  sending=true;
  DeviceOrientationEvent.requestPermission?.().then(()=>{
    window.addEventListener("deviceorientation",onOri);
  }).catch(()=>{
    window.addEventListener("deviceorientation",onOri);
  });
}
function stopSend(){
  btn.classList.add("inactive");
  sending=false;
  window.removeEventListener("deviceorientation",onOri);
}
function onOri(e){
  if(!sending) return;
  const a=(e.gamma||0 + e.beta||0)/2;
  socket.emit("sensor",{angle:a});
}

/* ===============================
   PC：受信 & 表示 & 音
================================ */
socket.on("sensor",data=>{
  if(isSmart) return;
  const a=data.angle||0;
  const st=angleToSemitone(a);
  const midi=BASE_MIDI+st;
  const f=midiToFreq(midi);

  angleEl.textContent=a.toFixed(1)+"°";
  noteEl.textContent=noteName(midi);
  freqEl.textContent=f.toFixed(2)+" Hz";

  startSound(f);
});

/* ===============================
   AI活用アイデア（課題用）
   - 音程に応じたコメント生成
   - 「今は明るい雰囲気！」など
   → Gemini API をここで呼ぶ
================================ */
// function requestAI(note){
//   // Gemini APIでコメント生成
//   // document.getElementById("aiComment").textContent = result;
// }
</script>
</body>
</html>
